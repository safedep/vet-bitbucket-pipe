#!/usr/bin/env bash

# ==============================================================================
# SafeDep Vet Pipe: Report Maker
#
# Report in BitBucket are part of its Code Insights Feature
#
# Report are basically:
#   TITLE, DESCRIPTION, LINKS, RESULT(PASS/FAIL), KEY-VALUE elements and ANNOTATIONS
#
# Docs: https://support.atlassian.com/bitbucket-cloud/docs/code-insights/
#
# code-insights-report.json contains metadata (title, desc, link, result and key-val elements etc)
# code-insights-annotations.json contains annotations (line by line markers)
#
# These 2 files are generated by a helper Go application which takes `vet-report.json` as input (this is generated by pipe.sh, --report-json)
# ==============================================================================

# 0. Args
VET_JSON_REPORT_PATH="$1"

# Check if the vet json report is given
if [ -z "$VET_JSON_REPORT_PATH" ]; then
    echo "Error: No file path provided."
    echo "Usage: $0 path/to/vet-report.json"
    exit 1
fi

echo "Generating report from: $VET_JSON_REPORT_PATH"

# Call gen-code-insights CLI to generate code-insights-*.json files
/gen-code-insights --json-report-file $VET_JSON_REPORT_PATH

# 1. Setup variables
REPO_PATH="${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO_SLUG}"
COMMIT="${BITBUCKET_COMMIT}"
PROXY="http://localhost:29418"
REPORT_ID="dependency-scan-$(date +%s)" # Unique Report ID

echo "Starting report upload for commit: $COMMIT"

# 2. Create the Base Report
cat <<EOF > code-insight-report.json
{
  "title": "SafeDep Dependency Scan",
  "details": "Automated security scan found multiple issues.",
  "report_type": "SECURITY",
  "reporter": "SafeDep",
  "result": "FAILED"
}
EOF

curl -s --proxy $PROXY -X PUT \
  "http://api.bitbucket.org/2.0/repositories/${REPO_PATH}/commit/${COMMIT}/reports/${REPORT_ID}" \
  -H "Content-Type: application/json" \
  -d @report.json

# 3. Create Bulk Annotations
# Note: We send an ARRAY [] of objects
cat <<EOF > code-insight-annotations.json
[
  {
    "external_id": "VULN-001",
    "title": "Critical: lodash vulnerability",
    "annotation_type": "VULNERABILITY",
    "summary": "Prototype Pollution in lodash. Upgrade to v4.17.21.",
    "severity": "CRITICAL",
    "path": "requirements.txt",
    "line": 1
  },
  {
    "external_id": "VULN-002",
    "title": "High: axios vulnerability",
    "annotation_type": "VULNERABILITY",
    "summary": "Server-Side Request Forgery (SSRF) in axios.",
    "severity": "HIGH",
    "path": "KUNAL.txt",
    "line": 2
  }
]
EOF

# 4. POST the array to the annotations endpoint
# Note: There is NO annotation ID in this URL because it is a bulk POST
curl -s --proxy $PROXY -X POST \
  "http://api.bitbucket.org/2.0/repositories/${REPO_PATH}/commit/${COMMIT}/reports/${REPORT_ID}/annotations" \
  -H "Content-Type: application/json" \
  -d @annotations.json

echo "Bulk annotations successfully posted to report: $REPORT_ID"

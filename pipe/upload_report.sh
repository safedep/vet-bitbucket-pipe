#!/usr/bin/env bash

# ==============================================================================
# SafeDep Vet Pipe: Report Maker
#
# Report in BitBucket are part of its Code Insights Feature
#
# Reports are basically:
#   TITLE, DESCRIPTION, LINKS, RESULT(PASS/FAIL), KEY-VALUE elements and ANNOTATIONS
#
# Docs: https://support.atlassian.com/bitbucket-cloud/docs/code-insights/
#
# The artifact files are generated by a helper Go application which takes `vet-report.json` as input (this is generated by pipe.sh, --report-json)
# ==============================================================================

echo ""
echo "[~] Running Scan Report and Annotation Update Script"
echo ""

# Args
VET_JSON_REPORT_PATH="$1"

# Check if the vet json report is given
if [ -z "$VET_JSON_REPORT_PATH" ]; then
    echo "Error: No file path provided."
    echo "Usage: $0 path/to/vet-report.json"
    exit 1
fi

echo "Generating report from: $VET_JSON_REPORT_PATH"

export DEST_CODE_INSIGHTS_REPORT_FILEPATH="vet-code-insights-report.json"
export DEST_CODE_INSIGHTS_ANNOTATIONS_FILEPATH="vet-code-insights-annotations.json"

# Call gen-code-insights CLI to generate code-insights-*.json files
/gen-code-insights --source-json-report-file "$VET_JSON_REPORT_PATH" --dest-report-file "$DEST_CODE_INSIGHTS_REPORT_FILEPATH" --dest-annotations-file "$DEST_CODE_INSIGHTS_ANNOTATIONS_FILEPATH"
if [ $? -ne 0 ]; then
    echo "Error: Failed to generate code insights reports"
    exit 1
fi

# Check if the these 2 new dest files are generated
if [ ! -f "$DEST_CODE_INSIGHTS_REPORT_FILEPATH" ]; then
    echo "Error: No report file generated at path $DEST_CODE_INSIGHTS_REPORT_FILEPATH."
    exit 1
fi
if [ ! -f "$DEST_CODE_INSIGHTS_ANNOTATIONS_FILEPATH" ]; then
    echo "Error: No report file generated at path $DEST_CODE_INSIGHTS_ANNOTATIONS_FILEPATH."
    exit 1
fi

# Setup variables
REPO_PATH="${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO_SLUG}"
COMMIT="${BITBUCKET_COMMIT}"
PROXY="http://host.docker.internal:29418"
REPORT_ID="safedep-vet-scan"

echo "Starting report upload for commit: $COMMIT"

# Create the Base Report
curl -s --proxy $PROXY -X PUT \
  "https://api.bitbucket.org/2.0/repositories/${REPO_PATH}/commit/${COMMIT}/reports/${REPORT_ID}" \
  -H "Content-Type: application/json" \
  -d @$DEST_CODE_INSIGHTS_REPORT_FILEPATH

# POST the array to the annotations endpoint
# Note: There is NO annotation ID in this URL because it is a bulk POST
curl -s --proxy $PROXY -X POST \
  "https://api.bitbucket.org/2.0/repositories/${REPO_PATH}/commit/${COMMIT}/reports/${REPORT_ID}/annotations" \
  -H "Content-Type: application/json" \
  -d @$DEST_CODE_INSIGHTS_ANNOTATIONS_FILEPATH

echo "Bulk annotations successfully posted to report: $REPORT_ID"
